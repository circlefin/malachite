name: Auto Label Issues
on:
  issues:
    types: [opened]

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: block
          policy: global-allowed-endpoints-policy

      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Check if opener is CODEOWNER
        id: check-codeowner
        run: |
          # Get the CODEOWNERS file content
          if [ -f .github/CODEOWNERS ]; then
            # Extract GitHub usernames from CODEOWNERS file
            CODEOWNERS=$(grep -v '^#' .github/CODEOWNERS | grep -o '@[a-zA-Z0-9-]*' | sed 's/@//')

            # Check if issue opener is in CODEOWNERS
            if echo "$CODEOWNERS" | grep -q "^${{ github.event.issue.user.login }}$"; then
              echo "is_codeowner=true" >> $GITHUB_OUTPUT
            else
              echo "is_codeowner=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "is_codeowner=false" >> $GITHUB_OUTPUT
          fi

      - name: Add need-triage label
        if: steps.check-codeowner.outputs.is_codeowner == 'false'
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['need-triage']
              });
              console.log('Successfully added `need-triage` label');
            } catch (error) {
              console.log('Error adding label:', error);
            }
