name: TODOs Tracking

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - code/**
      - .github/workflows/todo-tracking.yml

permissions:
  contents: read

jobs:
  update-todos:
    name: Update TODOs and FIXMEs
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      id-token: write
    steps:
      - name: Harden the runner
        uses: step-security/harden-runner@95d9a5deda9de15063e7595e9719c11c38c90ae2 # v2.13.2
        with:
          egress-policy: block
          policy: global-allowed-endpoints-policy

      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0

      - name: Set up Python
        uses: actions/setup-python@7f4fc3e22c37d6ff65e88745f38bd3157c663f7c # v4.9.1
        with:
          python-version: "3.x"

      - name: Generate TODOs list
        run: python scripts/todos.py

      - name: Update issue and timestamp
        uses: actions/github-script@d7906e4ad0b1822421a7e6a35d5ca353c962f410 # v6.4.1
        with:
          script: |
            const fs = require('fs');
            const todoContent = fs.readFileSync('TODO.md', 'utf8');

            // Find or create the tracking issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['todo-tracking'],
              state: 'open'
            });

            let issueNumber;
            if (issues.data.length === 0) {
              const newIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'code: TODOs and FIXMES',
                body: todoContent,
                labels: ['todo-tracking']
              });
              issueNumber = newIssue.data.number;

              // Create initial timestamp comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `Last updated: ${new Date().toISOString()}`
              });
            } else {
              issueNumber = issues.data[0].number;

              // Update issue content
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: todoContent
              });

              // Find and update the timestamp comment
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber
              });

              const timestampComment = comments.data.find(comment =>
                comment.body.startsWith('Last updated:')
              );

              if (timestampComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: timestampComment.id,
                  body: `Last updated: ${new Date().toISOString()}`
                });
              } else {
                // Create timestamp comment if it doesn't exist
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `Last updated: ${new Date().toISOString()}`
                });
              }
            }
